# We're doing more with our Serious Injury Outcome Indicators data
# Come with us as we explore Suicide and Intentional Self-Harm in more detail
# Please note: this code is designed to work on Stats NZ systems, therefore file paths / folders will only be applicable in that environment
# Warning: this code deals with the subject of suicide and may be distressing for some people

# Research question: are suicides different from non-fatal intentional self-harm?

# 1. Set working directory
# setwd("~/Network-Shares/U-Drive-SAS-02BAU/SocPopStats/CPR/Injury/Chartbooks")

# 2. Install some required packages
# Our data is stored in SAS datasets (sas7bdat) with compression, so the "sas7bdat" package won't work
# Instead we need "haven"
# see https://garthtarr.github.io/meatR/rio.html for more
install.packages("haven")
library(haven)

#ethnic vectors
European <- c('11','12','13')
Maori <- c('21')
Pacific <- c('30','31','32','33','34','35','36','37')
Asian <- c('40','41','42','43','44')
MEELA <- c('51','52','53')
Other <- c('54','61','94','95','97','99')

# SNF
snf_dat = read_sas("sernonfatalevents2017withwork.sas7bdat")
snf_dat$ecode3 <- substr(snf_dat$ecode4, 1, 3)
snf_dat$severity <- 'SNF'
snf_dat$year <- snf_dat$dischyear

SNF_dat1 <- snf_dat[ which(snf_dat$selfharm=='1'),]

# https://stackoverflow.com/questions/12125980/how-to-create-a-new-variable-in-a-data-frame-based-on-a-condition 
# https://datascienceplus.com/create-new-variable-in-r/

#Create ethnicity flags: European , Maori , Pacific , Asian , MEELA based on nhi_ethnic_prioritised_code
#to do

# Fatal
fat_dat = read_sas("fatals2017.sas7bdat")
fat_dat$ecode3 <- substr(fat_dat$ECODE, 1, 3)
fat_dat$severity <- 'Fat'
fat_dat$year <- fat_dat$year_code
fat_dat$ecode4 <- fat_dat$ECODE
fat_dat$age <- fat_dat$AGE_IN_YRS_code
fat_dat$sex_code <- fat_dat$nhi_sex_code

fat_dat1 <- fat_dat[ which(fat_dat$selfharm=='1'),]

#Create ethnicity flags: European , Maori , Pacific , Asian , MEELA based on ethnicGp_code
#to do (see: https://stat.ethz.ch/pipermail/r-help/2007-October/144284.html)

# Combined Fatal and SNF
# make columns match
# to do
# append
data <- rbind(snf_dat1, fat_dat1) 

# Tables for analysis
